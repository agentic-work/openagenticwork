# Copyright (c) 2025 Agenticwork LLC
# For all inquiries, please contact:
# Agenticwork LLC
# hello@agenticwork.io

server {
    listen 80;
    server_name _;
    root /usr/share/nginx/html;
    index index.html;

    # Allow larger file uploads (images, etc.)
    client_max_body_size 100M;

    # DNS resolver for dynamic upstream resolution
    # This allows nginx to resolve hostnames at runtime instead of startup
    # DNS_RESOLVER is set dynamically from /etc/resolv.conf at container startup
    # In Docker: 127.0.0.11, in K8s: cluster DNS (e.g., 10.43.0.10)
    resolver ${DNS_RESOLVER} valid=30s ipv6=off;

    # ===========================================
    # AUTHENTICATION SUBREQUEST ENDPOINT
    # ===========================================
    # Used by auth_request to validate user session before allowing access
    # to protected resources like Flowise API
    location = /internal/auth/verify {
        internal;
        proxy_pass http://${API_HOST}:${API_PORT}/api/auth/verify;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-Original-Method $request_method;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header Cookie $http_cookie;
        proxy_set_header X-AgenticWork-Frontend "${FRONTEND_SECRET}";
    }

    # Flowise SSO Success endpoint - MUST NOT require auth (it completes the SSO flow)
    # This endpoint exchanges the SSO token for user data and establishes the session
    # Using ^~ prefix to take priority over /api/v1/ location which has auth_request
    # NOTE: Using variable in proxy_pass enables runtime DNS resolution (requires resolver)
    location ^~ /api/v1/auth/sso-success {
        set $flowise_backend "http://${FLOWISE_HOST}:${FLOWISE_PORT}";
        proxy_pass $flowise_backend/api/v1/auth/sso-success;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;

        # Pass cookies back from Flowise
        proxy_pass_header Set-Cookie;
    }

    # ===========================================
    # API V1 ROUTES - AgenticWork API Backend
    # ===========================================
    # These specific routes go to our API backend
    # Must come BEFORE the generic /api/v1/ Flowise proxy

    # MCP routes - unified MCP management
    location ^~ /api/v1/mcp/ {
        proxy_pass http://${API_HOST}:${API_PORT};
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header Cookie $http_cookie;
        proxy_set_header X-AgenticWork-Frontend "${FRONTEND_SECRET}";
    }

    # Models routes - available LLM models
    location ^~ /api/v1/models {
        proxy_pass http://${API_HOST}:${API_PORT};
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header Cookie $http_cookie;
        proxy_set_header X-AgenticWork-Frontend "${FRONTEND_SECRET}";
    }

    # API v1 status endpoint
    location = /api/v1/status {
        proxy_pass http://${API_HOST}:${API_PORT};
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header X-AgenticWork-Frontend "${FRONTEND_SECRET}";
    }

    # Milvus API routes (for Attu embedded in Admin Portal)
    # Attu makes requests to /api/v1/milvus/* which need to be proxied to Attu backend
    location ^~ /api/v1/milvus/ {
        proxy_pass http://${ATTU_HOST}:${ATTU_PORT}/api/v1/milvus/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header Cookie $http_cookie;
    }

    # ===========================================
    # FLOWISE API V1 PROXY (for iframe compatibility)
    # ===========================================
    # CRITICAL FIX: Proxy /api/v1/* to Flowise for iframe compatibility
    # Flowise's frontend makes absolute path requests to /api/v1/* which need to be proxied
    # This catches remaining /api/v1/* routes not handled above
    # SECURITY: Protected by auth_request - requires valid session
    # NOTE: Using variable in proxy_pass enables runtime DNS resolution (requires resolver)
    location /api/v1/ {
        # Require authentication before proxying to Flowise
        auth_request /internal/auth/verify;
        auth_request_set $auth_status $upstream_status;

        set $flowise_backend "http://${FLOWISE_HOST}:${FLOWISE_PORT}";
        proxy_pass $flowise_backend/api/v1/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header Cookie $http_cookie;

        # Allow CORS for Flowise iframe
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type' always;

        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }

    # Proxy all API requests to backend
    location /api/ {
        proxy_pass http://${API_HOST}:${API_PORT};
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header X-User-ID $http_x_user_id;
        # Frontend security header - injected by nginx proxy
        proxy_set_header X-AgenticWork-Frontend "${FRONTEND_SECRET}";

        # CRITICAL: SSE streaming support - disable ALL buffering
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
        # Tell upstream proxies not to buffer
        proxy_set_header X-Accel-Buffering "no";
        # Ensure chunked encoding works
        chunked_transfer_encoding on;
        # Disable gzip for SSE (breaks chunked streaming)
        gzip off;
    }

    # ===========================================
    # AWCODE PTY WEBSOCKET TERMINAL
    # ===========================================
    # Real PTY terminal for AgenticWorkCode CLI
    # Proxies WebSocket to awcode-manager service
    location /api/code/ws/terminal {
        # Forward query params (sessionId, token for auth)
        proxy_pass http://${AWCODE_MANAGER_HOST}:${AWCODE_MANAGER_PORT}/ws/terminal$is_args$args;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # AWCode structured events WebSocket (V2 inline UI)
    location /api/code/ws/events {
        # CRITICAL: $is_args$args forwards query params (userId, token, sessionId)
        # Without this, user auth tokens are stripped and CLI falls back to Ollama mode
        proxy_pass http://${AWCODE_MANAGER_HOST}:${AWCODE_MANAGER_PORT}/ws/events$is_args$args;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # AWCode session management REST API
    location /api/code/sessions {
        # Forward query params for session filtering
        proxy_pass http://${AWCODE_MANAGER_HOST}:${AWCODE_MANAGER_PORT}/sessions$is_args$args;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header X-AgenticWork-Frontend "${FRONTEND_SECRET}";
    }

    # ===========================================
    # CODE-SERVER - VS Code Web IDE (Dynamic Ports)
    # ===========================================
    # Each code-server session runs on a dynamic port (3100-3199)
    # URL format: /code-server/{port}/?folder=...
    # Proxies to agenticode-manager container on the specified port
    location ~ ^/code-server/(\d+)/(.*)$ {
        # $1 = port number, $2 = remaining path
        proxy_pass http://${CODE_SERVER_HOST}:$1/$2$is_args$args;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Accept-Encoding gzip;

        # WebSocket support for VS Code
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;

        # Disable buffering for real-time updates
        proxy_buffering off;
    }

    # Also handle root code-server path without trailing content
    location ~ ^/code-server/(\d+)/?$ {
        proxy_pass http://${CODE_SERVER_HOST}:$1/$is_args$args;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Accept-Encoding gzip;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
        proxy_buffering off;
    }

    # DEDICATED SSE endpoint for chat streaming - maximum compatibility
    location /api/chat/stream {
        proxy_pass http://${API_HOST}:${API_PORT};
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header X-User-ID $http_x_user_id;
        proxy_set_header X-AgenticWork-Frontend "${FRONTEND_SECRET}";
        proxy_set_header Connection '';

        # CRITICAL SSE settings
        proxy_buffering off;
        proxy_cache off;
        proxy_set_header X-Accel-Buffering "no";
        chunked_transfer_encoding on;
        gzip off;

        # Long timeout for streaming
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;

        # SSE specific headers
        add_header Cache-Control 'no-cache, no-store, must-revalidate';
        add_header X-Accel-Buffering 'no';
    }
    
    # Remove conflicting proxy routes - these should be handled by React Router
    
    # UI doesn't need to expose metrics - Prometheus should scrape API directly
    location /metrics {
        return 404;
    }
    
    # UI health check endpoint
    location /ui-health {
        access_log off;
        return 200 "UI healthy\n";
        add_header Content-Type text/plain;
    }
    
    location /health {
        proxy_pass http://${API_HOST}:${API_PORT};
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-AgenticWork-Frontend "${FRONTEND_SECRET}";
    }
    
    # Handle auth callback routing - serve frontend, let React Router handle it
    location /auth/callback {
        try_files $uri $uri/ /index.html;
    }
    
    # Local auth requests now use /api/auth/local/* path directly via ingress
    # No special proxy needed since ingress routes /api/* to API service
    
    # Proxy MCP Inspector requests - both paths
    location /mcp-inspector/ {
        proxy_pass http://${MCP_HOST}:${MCP_PORT}/api/inspector/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
    }
    
    # Proxy API Inspector UI requests (for Admin Portal iframe)
    location /api/inspector/ {
        proxy_pass http://${MCP_HOST}:${MCP_PORT}/api/inspector/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # Pass through Authorization header for authentication
        proxy_set_header Authorization $http_authorization;
        proxy_pass_header Authorization;
        proxy_buffering off;
    }
    
    # Proxy MCP Orchestrator UI
    location /mcp-orchestrator/ {
        proxy_pass http://${MCP_HOST}:${MCP_PORT}/ui/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
    }
    
    # Proxy MCP Orchestrator WebSocket
    location /api/mcp-orchestrator/ws {
        proxy_pass http://${MCP_HOST}:${MCP_PORT}/socket.io/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # ===========================================
    # REDIS COMMANDER PROXY
    # ===========================================
    # Admin tool for Redis inspection and debugging
    # NOTE: No auth_request - embedded in already-authenticated Admin Portal
    # Redis Commander runs with authentication DISABLED (no HTTP_USER/HTTP_PASSWORD)
    # Access is controlled by Admin Portal authentication (is_admin check)
    location ^~ /redis-commander/ {
        proxy_pass http://${REDIS_COMMANDER_HOST}:${REDIS_COMMANDER_PORT}/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;

        # Allow iframe embedding from same origin
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Content-Security-Policy;
    }

    # ===========================================
    # ATTU (MILVUS ADMIN) PROXY
    # ===========================================
    # Admin tool for Milvus vector database
    # NOTE: No auth_request - embedded in already-authenticated Admin Portal
    # Milvus itself is on internal network only, Attu provides the admin UI
    location ^~ /attu/ {
        proxy_pass http://${ATTU_HOST}:${ATTU_PORT}/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header Cookie $http_cookie;

        # Allow iframe embedding from same origin
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Content-Security-Policy;

        # Disable gzip to allow sub_filter if needed
        proxy_set_header Accept-Encoding "";
    }

    # Flowise WebSocket connections - MUST come BEFORE the main /flowise/ block
    # Using ^~ to prevent regex location matching (like static asset regex)
    # NOTE: Using variable in proxy_pass enables runtime DNS resolution (requires resolver)
    location ^~ /flowise/socket.io/ {
        set $flowise_backend "http://${FLOWISE_HOST}:${FLOWISE_PORT}";
        proxy_pass $flowise_backend/socket.io/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # Flowise main proxy - simple passthrough
    # Flowise is built with vite base: '/flowise/' so no URL rewriting needed
    # Using ^~ to prevent regex location matching (like static asset regex)
    # SECURITY: Flowise auth disabled - relying on ingress-level auth (Azure AD/local)
    # NOTE: Using variable in proxy_pass enables runtime DNS resolution (requires resolver)
    location ^~ /flowise/ {
        set $flowise_backend "http://${FLOWISE_HOST}:${FLOWISE_PORT}";
        proxy_pass $flowise_backend/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header Cookie $http_cookie;

        # Allow Flowise to be embedded in iframe
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Content-Security-Policy;

        # Timeouts for long operations
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # Flowise SSO endpoint - MUST NOT require auth_request (it IS the auth endpoint)
    # This allows the frontend to authenticate with Flowise using the AgenticWork token
    # NOTE: Using variable in proxy_pass enables runtime DNS resolution (requires resolver)
    location ^~ /flowise/api/v1/agenticwork/ {
        set $flowise_backend "http://${FLOWISE_HOST}:${FLOWISE_PORT}";
        proxy_pass $flowise_backend/api/v1/agenticwork/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header Accept $http_accept;
        proxy_set_header X-Flowise-Response $http_x_flowise_response;
        proxy_set_header Cookie $http_cookie;

        # Pass cookies back from Flowise (for SSO token setting)
        proxy_pass_header Set-Cookie;
    }

    # Flowise API proxy (legacy route for direct API calls)
    # Using ^~ to take precedence over the main /flowise/ location
    # SECURITY: Protected by auth_request - requires valid session
    # NOTE: Using variable in proxy_pass enables runtime DNS resolution (requires resolver)
    location ^~ /flowise/api/ {
        # Require authentication before proxying to Flowise API
        auth_request /internal/auth/verify;
        auth_request_set $auth_status $upstream_status;

        set $flowise_backend "http://${FLOWISE_HOST}:${FLOWISE_PORT}";
        proxy_pass $flowise_backend/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header Cookie $http_cookie;

        # Pass cookies back from Flowise
        proxy_pass_header Set-Cookie;
    }

    # Serve Documentation (Docusaurus) from local build
    # Redirect /docs to /docs/ai/ where the main index.html exists
    location = /docs {
        return 301 /docs/ai/;
    }

    location /docs/ {
        alias /usr/share/nginx/html/docs/;
        try_files $uri $uri/ /docs/ai/index.html;

        # Allow iframe embedding from same origin for DocsViewer
        add_header X-Frame-Options "SAMEORIGIN" always;

        # Never cache JSON files (documentation index, etc.)
        location ~* \.json$ {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
        }

        # Cache documentation assets
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 7d;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # Serve static assets - try local first, then proxy to Flowise
    # This allows Flowise UI to work when loaded at /flowise/ with absolute asset paths
    location /assets/ {
        root /usr/share/nginx/html;
        # Try local file first, if not found proxy to Flowise
        try_files $uri @flowise_assets;
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Build-Time "2025-07-25-21:05";
    }

    # Fallback for Flowise assets not found locally
    # NOTE: Using variable in proxy_pass enables runtime DNS resolution (requires resolver)
    location @flowise_assets {
        set $flowise_backend "http://${FLOWISE_HOST}:${FLOWISE_PORT}";
        proxy_pass $flowise_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Serve config.js with no caching
    location = /config.js {
        root /usr/share/nginx/html;
        try_files $uri =404;
        add_header Content-Type application/javascript;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    # Cache other static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Serve frontend for all other routes - with no-cache for HTML
    location / {
        try_files $uri $uri/ /index.html;
        # Prevent caching of HTML files to ensure fresh JavaScript references
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }
    
    # Enable gzip compression
    gzip on;
    gzip_types text/plain text/css text/javascript application/javascript application/json;
    gzip_min_length 1000;
}
