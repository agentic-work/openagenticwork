# Agenticode Manager - Orchestrates CLI sessions per user
# Build context: repo root (.)
#
# SECURITY MODEL:
# - Manager runs as root to create/delete sandbox users
# - Each session spawns CLI as a unique Linux user (aw_<sessionId>)
# - Sandbox users can ONLY access their own workspace directory
# - Works in both Docker Compose and Kubernetes (no Docker-specific features)
#
# This Dockerfile uses pre-built CLI to avoid npm auth complexity during build.
# To update CLI: rebuild in agenticode-cli/ then rebuild this image.

# Build Manager (needs build tools for node-pty native module)
FROM node:20-slim AS manager-builder

# Install build dependencies for node-pty
RUN apt-get update && apt-get install -y --no-install-recommends \
  python3 \
  make \
  g++ \
  && apt-get clean \
  && rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY services/agenticode-manager/package*.json ./
RUN npm install

COPY services/agenticode-manager/tsconfig.json ./
COPY services/agenticode-manager/src ./src

RUN npm run build

# Production image
FROM node:20-slim

LABEL maintainer="AgenticWork <engineering@agenticwork.io>"
LABEL description="Agenticode Manager - provisions CLI sessions per user"

# Install runtime dependencies including development tools
RUN apt-get update && apt-get install -y --no-install-recommends \
  curl \
  git \
  ripgrep \
  procps \
  # Python
  python3 \
  python3-pip \
  python3-venv \
  # Go
  golang-go \
  # C/C++
  gcc \
  g++ \
  make \
  # Additional utilities
  jq \
  wget \
  unzip \
  # code-server dependencies
  dumb-init \
  openssh-client \
  sudo \
  # PowerShell dependencies
  apt-transport-https \
  ca-certificates \
  gnupg \
  && apt-get clean \
  && rm -rf /var/lib/apt/lists/* \
  # Create python symlink for convenience
  && ln -sf /usr/bin/python3 /usr/bin/python

# Install PowerShell Core 7 for cross-platform scripting
RUN curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor -o /usr/share/keyrings/microsoft-archive-keyring.gpg \
  && echo "deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft-archive-keyring.gpg] https://packages.microsoft.com/repos/microsoft-debian-bullseye-prod bullseye main" > /etc/apt/sources.list.d/microsoft.list \
  && apt-get update \
  && apt-get install -y --no-install-recommends powershell \
  && rm -rf /var/lib/apt/lists/* \
  && pwsh --version

ENV POWERSHELL_TELEMETRY_OPTOUT=1
ENV DOTNET_CLI_TELEMETRY_OPTOUT=1

# Install code-server (VS Code in browser)
# Each user session will spawn its own code-server instance on a unique port
ARG CODE_SERVER_VERSION=4.96.4
RUN curl -fsSL https://github.com/coder/code-server/releases/download/v${CODE_SERVER_VERSION}/code-server_${CODE_SERVER_VERSION}_amd64.deb -o /tmp/code-server.deb \
  && dpkg -i /tmp/code-server.deb \
  && rm /tmp/code-server.deb \
  # Create directory for code-server data per user
  && mkdir -p /var/lib/code-server \
  && chmod 755 /var/lib/code-server

# Pre-install common VS Code extensions at build time
# These are shared read-only across all sessions (installed to /var/lib/code-server/extensions)
ENV EXTENSIONS_DIR=/var/lib/code-server/extensions
RUN mkdir -p $EXTENSIONS_DIR \
  # Python - core Python development (includes Jedi LSP, not Pylance which is MS proprietary)
  && code-server --extensions-dir $EXTENSIONS_DIR --install-extension ms-python.python \
  # PowerShell - cross-platform PowerShell support
  && code-server --extensions-dir $EXTENSIONS_DIR --install-extension ms-vscode.powershell \
  # TypeScript/JavaScript - ESLint for linting
  && code-server --extensions-dir $EXTENSIONS_DIR --install-extension dbaeumer.vscode-eslint \
  # Prettier - code formatter
  && code-server --extensions-dir $EXTENSIONS_DIR --install-extension esbenp.prettier-vscode \
  # Go - Golang support (we have Go installed)
  && code-server --extensions-dir $EXTENSIONS_DIR --install-extension golang.go \
  # YAML - for configs, k8s manifests, etc.
  && code-server --extensions-dir $EXTENSIONS_DIR --install-extension redhat.vscode-yaml \
  # GitLens - enhanced Git integration
  && code-server --extensions-dir $EXTENSIONS_DIR --install-extension eamodio.gitlens \
  # Markdown All in One - markdown preview and editing
  && code-server --extensions-dir $EXTENSIONS_DIR --install-extension yzhang.markdown-all-in-one \
  # Material Icon Theme - nice file icons
  && code-server --extensions-dir $EXTENSIONS_DIR --install-extension pkief.material-icon-theme \
  # Path Intellisense - file path autocomplete
  && code-server --extensions-dir $EXTENSIONS_DIR --install-extension christian-kohler.path-intellisense \
  # REST Client - for testing APIs
  && code-server --extensions-dir $EXTENSIONS_DIR --install-extension humao.rest-client \
  # PDF Preview - view PDF files directly in VS Code
  && code-server --extensions-dir $EXTENSIONS_DIR --install-extension tomoki1207.pdf \
  # Hex Editor - for binary file inspection (useful for various file types)
  && code-server --extensions-dir $EXTENSIONS_DIR --install-extension ms-vscode.hexeditor \
  # Excel Viewer - for CSV/Excel files
  && code-server --extensions-dir $EXTENSIONS_DIR --install-extension grapecity.gc-excelviewer

# Make extensions directory read-only to prevent users from modifying
RUN chmod -R 755 $EXTENSIONS_DIR

WORKDIR /app

# Copy manager with pre-built node_modules (includes native node-pty)
COPY services/agenticode-manager/package*.json ./
COPY --from=manager-builder /app/node_modules ./node_modules
COPY --from=manager-builder /app/dist ./dist

# Copy and BUILD SDK (required by agenticode CLI as file dependency)
COPY sdk ./sdk
WORKDIR /app/sdk
RUN npm install && npm run build
WORKDIR /app

# Copy pre-built agenticode CLI (built locally with proper npm auth)
# The CLI dist and node_modules are built locally then copied here
COPY agenticode-cli/dist ./agenticode/dist
COPY agenticode-cli/package.json ./agenticode/
COPY agenticode-cli/node_modules ./agenticode/node_modules

# Fix SDK symlink: The local node_modules has @agentic-work/sdk -> ../../../sdk
# which resolves incorrectly in Docker. Replace symlink with actual SDK content.
RUN rm -rf /app/agenticode/node_modules/@agentic-work/sdk \
  && mkdir -p /app/agenticode/node_modules/@agentic-work \
  && cp -r /app/sdk /app/agenticode/node_modules/@agentic-work/sdk

# Create shell wrapper script for agenticode command
# The CLI is ESM so we need to run it with node directly
RUN printf '#!/bin/sh\nexec node /app/agenticode/dist/index.js "$@"\n' > /usr/local/bin/agenticode \
  && chmod +x /usr/local/bin/agenticode \
  && chmod +x /app/agenticode/dist/index.js

# Create workspaces directory with restricted permissions
# Root owns it, but sandbox users will get their own subdirectories
RUN mkdir -p /workspaces \
  && chmod 711 /workspaces

# Ensure /etc/passwd and /etc/group are writable for user creation
# This is needed for the manager to create sandbox users dynamically
# SECURITY: /etc/shadow stays 640 root:shadow - only passwd/group need to be writable
RUN chmod 644 /etc/passwd /etc/group \
  && chmod 640 /etc/shadow 2>/dev/null || true

# Expose manager port and code-server port range
# 3050: Manager API
# 3100-3199: Per-user code-server instances
EXPOSE 3050
EXPOSE 3100-3199

# IMPORTANT: Manager runs as root to enable user sandboxing
# CLI processes run as isolated sandbox users (aw_<sessionId>)
# If you need to run without root, sandboxing will be disabled automatically

ENV AGENTICODE_PATH=/usr/local/bin/agenticode
ENV WORKSPACES_PATH=/workspaces

# Code-server configuration
ENV CODE_SERVER_BINARY=/usr/bin/code-server
ENV CODE_SERVER_BASE_PORT=3100
ENV CODE_SERVER_MAX_INSTANCES=100
ENV CODE_SERVER_USER_DATA_DIR=/var/lib/code-server
ENV CODE_SERVER_EXTENSIONS_DIR=/var/lib/code-server/extensions
ENV CODE_SERVER_EXTERNAL_URL=/code-server
ENV CODE_SERVER_STARTUP_TIMEOUT=30000

# Health check for Kubernetes and Docker Compose
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3050/health || exit 1

CMD ["npm", "start"]
